<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --dark: #333;
            --light: #f8f9fa;
            --gray: #666;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .screen { padding: 40px 30px; text-align: center; display: none; }
        .screen.active { display: block; }
        .icon { font-size: 80px; color: var(--primary); margin-bottom: 25px; }
        .title { font-size: 32px; color: var(--dark); margin-bottom: 15px; font-weight: 600; }
        .subtitle { font-size: 18px; color: var(--gray); line-height: 1.5; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .btn { background: var(--primary); color: white; border: none; padding: 18px 30px; border-radius: 12px; font-size: 18px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 15px; transition: all 0.3s ease; width: 100%; max-width: 350px; margin: 15px auto; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.3); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none !important; }
        .btn-google { background: #4285f4; }
        .btn-google:hover { background: #3367d6; }
        .btn-telegram { background: #0088cc; }
        .btn-telegram:hover { background: #0077b3; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        .form-group { margin-bottom: 25px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--primary); outline: none; }
        .form-textarea { min-height: 120px; resize: vertical; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .notification { position: fixed; top: 20px; right: 20px; background: white; border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-width: 350px; animation: slideIn 0.3s ease; display: none; }
        .notification.error { border-left-color: var(--danger); }
        .notification.success { border-left-color: var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .user-info { background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; }
        .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .user-details h3 { margin: 0; color: var(--dark); font-size: 18px; }
        .user-details p { margin: 5px 0 0; color: var(--gray); font-size: 14px; }
        
        .alert { padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left; }
        .alert-info { background: #e7f3ff; border: 1px solid #b3d7ff; color: #0066cc; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        
        .photo-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; background: #f0f0f0; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo { position: absolute; top: 5px; right: 5px; background: rgba(255,107,107,0.9); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; border: none; }
        
        .telegram-info { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: left; }
        .telegram-info p { margin: 5px 0; color: #1565c0; }
        
        .google-signin-container { margin: 30px auto; text-align: center; }
        
        .draft-notice { background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px 15px; margin: 15px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .draft-notice button { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        
        .ad-status { padding: 10px 15px; border-radius: 8px; margin: 10px 0; }
        .ad-status.published { background: #d4edda; color: #155724; }
        .ad-status.failed { background: #f8d7da; color: #721c24; }
        
        @media (max-width: 768px) {
            .screen { padding: 30px 20px; }
            .title { font-size: 24px; }
            .subtitle { font-size: 16px; }
            .btn { padding: 15px 20px; font-size: 16px; }
            .user-info { padding: 15px; }
            .user-avatar { width: 50px; height: 50px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
        <div class="screen active" id="step1">
            <i class="fas fa-spinner icon fa-spin"></i>
            <h1 class="title">Flower Market</h1>
            <p class="subtitle">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...</p>
            <div id="loader1">
                <div class="loader"></div>
                <p style="margin-top: 15px; color: var(--gray);">–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...</p>
            </div>
        </div>
        
        <!-- –®–ê–ì 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google -->
        <div class="screen" id="step2">
            <i class="fas fa-user-lock icon"></i>
            <h1 class="title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
            <p class="subtitle">
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
            </p>
            
            <div style="max-width: 400px; margin: 0 auto;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                <div id="telegramInfo" class="telegram-info" style="display: none;">
                    <p><i class="fab fa-telegram"></i> <strong>Telegram:</strong> <span id="telegramName"></span></p>
                    <p><i class="fas fa-id-card"></i> <strong>ID:</strong> <span id="telegramId"></span></p>
                </div>
                
                <div class="alert alert-info">
                    <p><i class="fas fa-info-circle"></i> –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</p>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ Google Sign-In -->
                <div class="google-signin-container">
                    <button class="btn btn-google" onclick="signInWithGoogle()" id="googleSignInBtn">
                        <i class="fab fa-google"></i>
                        <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                    </button>
                </div>
                
                <div id="authLoader" style="display: none;">
                    <div class="loader"></div>
                    <p style="margin-top: 15px; color: var(--gray);">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...</p>
                </div>
                
                <div id="authError" class="alert alert-error" style="display: none;">
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</strong></p>
                    <p id="authErrorMessage" style="margin-top: 5px; font-size: 14px;"></p>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <p style="color: var(--gray); font-size: 14px;">
                        <i class="fas fa-shield-alt"></i> –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã
                    </p>
                    <p style="color: var(--gray); font-size: 12px; margin-top: 10px;">
                        –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                    </p>
                </div>
            </div>
        </div>
        
        <!-- –®–ê–ì 3: –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="screen" id="step3">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 class="title">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h1>
                <p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram –∫–∞–Ω–∞–ª–µ</p>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h3 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p id="userEmail">email@example.com</p>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <span style="background: var(--success); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                            <i class="fas fa-check"></i> –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                        </span>
                        <span style="background: var(--primary); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                            <i class="fab fa-telegram"></i> Telegram
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —á–µ—Ä–Ω–æ–≤–∏–∫–µ -->
            <div id="draftNotice" class="draft-notice" style="display: none;">
                <div>
                    <strong><i class="fas fa-save"></i> –ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫</strong>
                    <p style="margin: 5px 0 0; font-size: 14px;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ <span id="draftTime"></span></p>
                </div>
                <button onclick="loadDraft()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            
            <form id="adForm" onsubmit="event.preventDefault(); submitAd();">
                <div class="form-group">
                    <label class="form-label" for="adTitle">
                        –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è *
                    </label>
                    <input type="text" id="adTitle" class="form-input" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–µ–∂–∏–µ —Ä–æ–∑—ã, –±—É–∫–µ—Ç –Ω–µ–≤–µ—Å—Ç—ã" 
                           required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adDescription">
                        –û–ø–∏—Å–∞–Ω–∏–µ *
                    </label>
                    <textarea id="adDescription" class="form-textarea form-input" 
                              placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ü–≤–µ—Ç—ã, —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥." 
                              required maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adPrice">
                        –¶–µ–Ω–∞ *
                    </label>
                    <input type="text" id="adPrice" class="form-input" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000 —Å–æ–º –∏–ª–∏ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adPhone">
                        –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω *
                    </label>
                    <input type="tel" id="adPhone" class="form-input" 
                           placeholder="+996 XXX XXX XXX" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5 —à—Ç—É–∫)</label>
                    <div style="border: 2px dashed var(--primary); border-radius: 10px; padding: 30px 20px; text-align: center; cursor: pointer; background: var(--light);" 
                         onclick="document.getElementById('photoInput').click()">
                        <i class="fas fa-camera" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
                        <p><strong>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</strong></p>
                        <p style="color: var(--gray); font-size: 14px; margin-top: 10px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</p>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple 
                           style="display: none;" onchange="handlePhotoUpload(event)">
                    
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn" onclick="saveDraft()" style="flex: 1; background: var(--gray);">
                        <i class="fas fa-save"></i>
                        <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="flex: 2;">
                        <i class="fas fa-paper-plane"></i>
                        <span>–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</span>
                    </button>
                </div>
            </form>
            
            <div id="formLoader" style="display: none; text-align: center; padding: 30px;">
                <div class="loader"></div>
                <p style="margin-top: 15px; color: var(--gray);">–ü—É–±–ª–∏–∫—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...</p>
            </div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                <button onclick="logout()" class="btn btn-danger" style="max-width: 200px;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>–í—ã–π—Ç–∏</span>
                </button>
                <p style="color: var(--gray); margin-top: 15px; font-size: 14px;">
                    <i class="fab fa-telegram"></i> Telegram ID: <strong id="displayTelegramId"></strong>
                </p>
            </div>
        </div>
        
        <!-- –®–ê–ì 4: –£—Å–ø–µ—à–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è -->
        <div class="screen" id="step4">
            <i class="fas fa-check-circle icon" style="color: var(--success);"></i>
            <h1 class="title">–£—Å–ø–µ—à–Ω–æ!</h1>
            <p class="subtitle" id="successMessage">
                –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ Telegram –∫–∞–Ω–∞–ª–µ
            </p>
            
            <div style="max-width: 400px; margin: 0 auto;">
                <div id="adStatus" class="ad-status published">
                    <p><i class="fas fa-check"></i> <strong>–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</strong></p>
                    <p style="margin: 10px 0;" id="adDetails"></p>
                </div>
                
                <button class="btn" onclick="createNewAd()" style="margin-top: 20px;">
                    <i class="fas fa-plus"></i>
                    <span>–°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω–æ</span>
                </button>
                
                <button class="btn btn-telegram" onclick="viewChannel()" style="margin-top: 10px;">
                    <i class="fab fa-telegram"></i>
                    <span>–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª</span>
                </button>
                
                <button class="btn" onclick="closeWebApp()" style="background: var(--gray); margin-top: 10px;">
                    <i class="fas fa-times"></i>
                    <span>–ó–∞–∫—Ä—ã—Ç—å</span>
                </button>
                
                <p style="color: var(--gray); margin-top: 30px; font-size: 14px;">
                    <i class="fas fa-info-circle"></i>
                    –ö–∞–Ω–∞–ª: <a href="https://t.me/flowers_market_kg" target="_blank" style="color: var(--primary);">@flowers_market_kg</a>
                </p>
            </div>
        </div>
        
        <!-- –®–ê–ì 5: –û—à–∏–±–∫–∞ -->
        <div class="screen" id="step5">
            <i class="fas fa-exclamation-triangle icon" style="color: var(--warning);"></i>
            <h1 class="title">–û—à–∏–±–∫–∞</h1>
            <p class="subtitle" id="errorMessage">
                –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
            </p>
            
            <div style="max-width: 400px; margin: 0 auto;">
                <div class="alert alert-error" id="errorDetails">
                    <p><i class="fas fa-times-circle"></i> <strong>–û—à–∏–±–∫–∞</strong></p>
                    <p style="margin: 10px 0;" id="errorText"></p>
                </div>
                
                <button class="btn" onclick="retry()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i>
                    <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>
                </button>
                
                <button class="btn btn-telegram" onclick="openTelegramBot()" style="margin-top: 10px;">
                    <i class="fab fa-telegram"></i>
                    <span>–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</span>
                </button>
                
                <p style="color: var(--gray); margin-top: 30px; font-size: 14px;">
                    –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
                </p>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const BACKEND_URL = 'https://backend-flower2-production.up.railway.app';
        const GOOGLE_CLIENT_ID = '316866498988-v1pqivbgh0eupcb9rs53m26nrqukn9hb.apps.googleusercontent.com';
        const TELEGRAM_BOT_URL = 'https://t.me/Flowers_free_bot';
        const TELEGRAM_CHANNEL_URL = 'https://t.me/flowers_market_kg';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userSession = null;
        let userData = null;
        let telegramId = null;
        let uploadedPhotos = [];
        let autoSaveInterval = null;
        let googleAuthWindow = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üå∫ Flower Market –∑–∞–ø—É—â–µ–Ω');
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            telegramId = urlParams.get('telegram_id');
            const tempId = urlParams.get('temp_id');
            const sessionToken = urlParams.get('session');
            const error = urlParams.get('error');
            
            if (error) {
                showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', error);
                return;
            }
            
            if (sessionToken) {
                // –ï—Å—Ç—å —Å–µ—Å—Å–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–µ
                await checkSession(sessionToken);
            } else if (tempId && telegramId) {
                // –ï—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID - –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
                await getTelegramData(tempId, telegramId);
            } else if (telegramId) {
                // –¢–æ–ª—å–∫–æ telegram_id - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await checkUser(telegramId);
            } else {
                // –ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                setTimeout(() => {
                    showStep(2);
                }, 1500);
            }
        });
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Telegram
        async function getTelegramData(tempId, telegramId) {
            try {
                console.log('üì± –ü–æ–ª—É—á–∞–µ–º Telegram –¥–∞–Ω–Ω—ã–µ...');
                const response = await fetch(`${BACKEND_URL}/api/telegram-data/${tempId}`);
                const result = await response.json();
                
                if (result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    document.getElementById('telegramInfo').style.display = 'block';
                    document.getElementById('telegramName').textContent = result.firstName;
                    document.getElementById('telegramId').textContent = result.telegramId;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º telegramId
                    telegramId = result.telegramId;
                    document.getElementById('displayTelegramId').textContent = telegramId;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    await checkUser(telegramId);
                } else {
                    showError('–û—à–∏–±–∫–∞ Telegram', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Telegram –¥–∞–Ω–Ω—ã—Ö:', error);
                showStep(2);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUser(telegramId) {
            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                const response = await fetch(`${BACKEND_URL}/api/user/check/${telegramId}`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.exists && result.isLoggedIn) {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –Ω—É–∂–Ω–∞ —Å–µ—Å—Å–∏—è
                        showStep(2);
                    } else {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                        showStep(2);
                    }
                } else {
                    showStep(2);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showStep(2);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
        async function checkSession(sessionToken) {
            try {
                console.log('üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é...');
                const response = await fetch(`${BACKEND_URL}/api/session/${sessionToken}`);
                const result = await response.json();
                
                if (result.success) {
                    userSession = sessionToken;
                    userData = result.user;
                    telegramId = result.user.telegramId;
                    
                    console.log('‚úÖ –°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞:', userData.name);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                    localStorage.setItem('flower_session', sessionToken);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º URL
                    updateUrlWithSession(sessionToken);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    updateUserInfo();
                    document.getElementById('displayTelegramId').textContent = telegramId;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    showStep(3);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
                    await checkDraft();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    startAutoSave();
                } else {
                    // –°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞
                    showStep(2);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                showStep(2);
            }
        }
        
        // –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        async function signInWithGoogle() {
            const googleBtn = document.getElementById('googleSignInBtn');
            const authLoader = document.getElementById('authLoader');
            const authError = document.getElementById('authError');
            
            googleBtn.style.display = 'none';
            authLoader.style.display = 'block';
            authError.style.display = 'none';
            
            try {
                // –°–æ–∑–¥–∞–µ–º Google OAuth URL
                const redirectUri = encodeURIComponent(window.location.origin);
                const scope = encodeURIComponent('email profile');
                const googleAuthUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}&state=${telegramId}`;
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                googleAuthWindow = window.open(googleAuthUrl, 'GoogleAuth', 'width=500,height=600,scrollbars=yes');
                
                if (!googleAuthWindow) {
                    throw new Error('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const checkAuthResult = setInterval(() => {
                    try {
                        if (googleAuthWindow.closed) {
                            clearInterval(checkAuthResult);
                            authLoader.style.display = 'none';
                            googleBtn.style.display = 'flex';
                            showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–û–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–æ', 'info');
                        }
                    } catch (e) {
                        clearInterval(checkAuthResult);
                        authLoader.style.display = 'none';
                        googleBtn.style.display = 'flex';
                    }
                }, 1000);
                
                // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                window.addEventListener('message', async function(event) {
                    if (event.origin !== window.location.origin) return;
                    
                    if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
                        clearInterval(checkAuthResult);
                        await handleGoogleAuthToken(event.data.token);
                        if (googleAuthWindow) {
                            googleAuthWindow.close();
                        }
                    } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
                        clearInterval(checkAuthResult);
                        authLoader.style.display = 'none';
                        googleBtn.style.display = 'flex';
                        showAuthError(event.data.error);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                authLoader.style.display = 'none';
                googleBtn.style.display = 'flex';
                showAuthError(error.message);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Google —Ç–æ–∫–µ–Ω–∞
        async function handleGoogleAuthToken(token) {
            try {
                console.log('üîê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Google —Ç–æ–∫–µ–Ω...');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥
                const response = await fetch(`${BACKEND_URL}/api/auth/google`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        telegramId: telegramId
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('authLoader').style.display = 'none';
                
                if (result.success) {
                    userSession = result.sessionToken;
                    userData = result.user;
                    
                    console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', userData.name);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                    localStorage.setItem('flower_session', userSession);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º URL
                    updateUrlWithSession(userSession);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateUserInfo();
                    document.getElementById('displayTelegramId').textContent = telegramId;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    showStep(3);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
                    await checkDraft();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    startAutoSave();
                    
                    showNotification('–£—Å–ø–µ—Ö', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.name}!`, 'success');
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('authLoader').style.display = 'none';
                document.getElementById('googleSignInBtn').style.display = 'flex';
                showAuthError(error.message);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthError(message) {
            const authError = document.getElementById('authError');
            const authErrorMessage = document.getElementById('authErrorMessage');
            
            authErrorMessage.textContent = message;
            authError.style.display = 'block';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function updateUserInfo() {
            if (!userData) return;
            
            document.getElementById('userName').textContent = userData.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userEmail').textContent = userData.email || '';
            
            const userAvatar = document.getElementById('userAvatar');
            if (userData.picture) {
                userAvatar.innerHTML = `<img src="${userData.picture}" alt="–ê–≤–∞—Ç–∞—Ä">`;
            } else {
                const firstName = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                userAvatar.innerHTML = firstName;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        async function checkDraft() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/draft/${userSession}`);
                const result = await response.json();
                
                if (result.success && result.exists) {
                    const draftNotice = document.getElementById('draftNotice');
                    const draftTime = document.getElementById('draftTime');
                    
                    const savedAt = new Date(result.draft.savedAt);
                    draftTime.textContent = savedAt.toLocaleString('ru-RU');
                    
                    draftNotice.style.display = 'flex';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        async function loadDraft() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/draft/${userSession}`);
                const result = await response.json();
                
                if (result.success && result.draft) {
                    const draft = result.draft;
                    
                    document.getElementById('adTitle').value = draft.title || '';
                    document.getElementById('adDescription').value = draft.description || '';
                    document.getElementById('adPrice').value = draft.price || '';
                    document.getElementById('adPhone').value = draft.contactInfo || '';
                    
                    if (draft.photos && draft.photos.length > 0) {
                        uploadedPhotos = draft.photos;
                        updatePhotoPreview();
                    }
                    
                    showNotification('–£—Å–ø–µ—Ö', '–ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫', 'error');
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        async function saveDraft() {
            try {
                const draftData = collectFormData();
                
                const response = await fetch(`${BACKEND_URL}/api/draft/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionToken: userSession,
                        draftData: draftData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error);
            }
        }
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            autoSaveInterval = setInterval(() => {
                const formData = collectFormData();
                if (formData.title || formData.description || formData.price || formData.contactInfo) {
                    saveDraft();
                }
            }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        }
        
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
        function collectFormData() {
            return {
                title: document.getElementById('adTitle').value.trim(),
                description: document.getElementById('adDescription').value.trim(),
                price: document.getElementById('adPrice').value.trim(),
                contactInfo: document.getElementById('adPhone').value.trim(),
                photos: uploadedPhotos,
                savedAt: new Date().toISOString()
            };
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const maxFiles = 5;
            
            if (files.length === 0) return;
            
            if (uploadedPhotos.length + files.length > maxFiles) {
                showNotification('–û—à–∏–±–∫–∞', `–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${maxFiles} —Ñ–æ—Ç–æ`, 'error');
                return;
            }
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', `–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`, 'warning');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', `–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)`, 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    
                    uploadedPhotos.push(photoData);
                    updatePhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            uploadedPhotos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.data}" alt="–§–æ—Ç–æ ${index + 1}" loading="lazy">
                    <button class="remove-photo" onclick="removePhoto(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(item);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            updatePhotoPreview();
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function submitAd() {
            const formData = collectFormData();
            
            if (!formData.title || !formData.description || !formData.price || !formData.contactInfo) {
                showNotification('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const formLoader = document.getElementById('formLoader');
            
            submitBtn.disabled = true;
            submitBtn.style.display = 'none';
            formLoader.style.display = 'block';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/publish-ad`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionToken: userSession,
                        ...formData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.telegramMessageId) {
                        document.getElementById('successMessage').textContent = '‚úÖ –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ Telegram –∫–∞–Ω–∞–ª–µ!';
                        document.getElementById('adDetails').innerHTML = `
                            <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${formData.title}<br>
                            <strong>–¶–µ–Ω–∞:</strong> ${formData.price}<br>
                            <strong>ID —Å–æ–æ–±—â–µ–Ω–∏—è:</strong> ${result.telegramMessageId}
                        `;
                        document.getElementById('adStatus').className = 'ad-status published';
                    } else {
                        document.getElementById('successMessage').textContent = '‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                        document.getElementById('adDetails').innerHTML = `
                            <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> ${formData.title}<br>
                            <strong>–¶–µ–Ω–∞:</strong> ${formData.price}<br>
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ)<br>
                            <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${result.error || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'}
                        `;
                        document.getElementById('adStatus').className = 'ad-status failed';
                    }
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('adForm').reset();
                    uploadedPhotos = [];
                    updatePhotoPreview();
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    if (autoSaveInterval) {
                        clearInterval(autoSaveInterval);
                        autoSaveInterval = null;
                    }
                    
                    showStep(4);
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞', error.message, 'error');
                
                submitBtn.disabled = false;
                submitBtn.style.display = 'flex';
                formLoader.style.display = 'none';
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
        function createNewAd() {
            showStep(3);
            startAutoSave();
        }
        
        // –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª
        function viewChannel() {
            window.open(TELEGRAM_CHANNEL_URL, '_blank');
        }
        
        // –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞
        function openTelegramBot() {
            window.open(TELEGRAM_BOT_URL, '_blank');
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å WebApp
        function closeWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.close();
            } else {
                showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Telegram –≤—Ä—É—á–Ω—É—é', 'info');
            }
        }
        
        // –í—ã–π—Ç–∏
        async function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                try {
                    await fetch(`${BACKEND_URL}/api/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sessionToken: userSession
                        })
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                }
                
                localStorage.removeItem('flower_session');
                userSession = null;
                userData = null;
                uploadedPhotos = [];
                
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                window.location.href = window.location.pathname;
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å URL —Å —Å–µ—Å—Å–∏–µ–π
        function updateUrlWithSession(sessionToken) {
            const newUrl = `${window.location.pathname}?session=${sessionToken}`;
            window.history.replaceState({}, '', newUrl);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —à–∞–≥
        function showStep(stepNumber) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —à–∞–≥–∏
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                if (step) step.classList.remove('active');
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π —à–∞–≥
            const currentStep = document.getElementById('step' + stepNumber);
            if (currentStep) {
                currentStep.classList.add('active');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(title, message) {
            document.getElementById('errorMessage').textContent = title;
            document.getElementById('errorText').textContent = message;
            showStep(5);
        }
        
        // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        function retry() {
            window.location.reload();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" 
                       style="color: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'}; 
                              margin-right: 10px; font-size: 20px;"></i>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">${title}</div>
                        <div style="color: var(--gray); font-size: 14px;">${message}</div>
                    </div>
                </div>
            `;
            
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google Popup (–¥–ª—è iframe/popup)
        function handleGooglePopupAuth() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL hash
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const error = params.get('error');
                
                if (error) {
                    window.opener.postMessage({
                        type: 'GOOGLE_AUTH_ERROR',
                        error: error
                    }, window.location.origin);
                } else if (accessToken) {
                    window.opener.postMessage({
                        type: 'GOOGLE_AUTH_SUCCESS',
                        token: accessToken
                    }, window.location.origin);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Google auth:', e);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google
        if (window.location.hash.includes('access_token')) {
            handleGooglePopupAuth();
        }
        
        console.log('‚úÖ Flower Market –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    </script>
</body>
</html>