<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flower Market - –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
            -webkit-font-smoothing: antialiased; 
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-screen {
            padding: 50px 30px;
            text-align: center;
        }
        
        .auth-icon {
            font-size: 80px;
            color: #667eea;
            margin-bottom: 25px;
        }
        
        .auth-title {
            font-size: 32px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .auth-subtitle {
            font-size: 18px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 40px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ Google */
        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 350px;
        }
        
        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66,133,244,0.3);
        }
        
        .google-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* –§–æ—Ä–º–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
        .form-container {
            padding: 30px;
            display: none;
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-details h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .user-details p {
            margin: 5px 0 0;
            color: #666;
            font-size: 14px;
        }
        
        /* –ü–æ–ª—è —Ñ–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 16px;
        }
        
        .form-label .required {
            color: #ff3b30;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ */
        .photo-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .photo-upload:hover {
            background: rgba(102,126,234,0.05);
            border-color: #764ba2;
        }
        
        .photo-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .photo-hint {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ */
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #f0f0f0;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,107,107,0.9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: none;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 30px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* –≠–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞ */
        .success-screen {
            padding: 50px 30px;
            text-align: center;
            display: none;
        }
        
        .success-icon {
            font-size: 80px;
            color: #34c759;
            margin-bottom: 25px;
        }
        
        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 350px;
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        .notification.error {
            border-left-color: #ff3b30;
        }
        
        .notification.success {
            border-left-color: #34c759;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .auth-screen, .form-container, .success-screen {
                padding: 30px 20px;
            }
            
            .auth-title {
                font-size: 24px;
            }
            
            .auth-subtitle {
                font-size: 16px;
            }
            
            .google-btn, .submit-btn {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .user-info {
                padding: 15px;
            }
            
            .user-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .auth-screen {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
        <div class="auth-screen" id="authScreen">
            <i class="fas fa-store auth-icon"></i>
            <h1 class="auth-title">Flower Market</h1>
            <p class="auth-subtitle">
                –°–æ–∑–¥–∞–π—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–∞–∂–µ —Ü–≤–µ—Ç–æ–≤ –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –µ–≥–æ –≤ –Ω–∞—à–µ–º Telegram –∫–∞–Ω–∞–ª–µ
            </p>
            
            <div id="googleSignInContainer">
                <button class="google-btn" onclick="signInWithGoogle()" id="googleSignInBtn">
                    <i class="fab fa-google"></i>
                    <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                </button>
                <p style="color: #666; margin-top: 15px; font-size: 14px;">
                    –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                </p>
            </div>
            
            <div id="authLoader" style="display: none;">
                <div class="loader"></div>
                <p style="margin-top: 15px; color: #666;">–í—Ö–æ–¥–∏–º –≤ –∞–∫–∫–∞—É–Ω—Ç...</p>
            </div>
        </div>
        
        <!-- –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –û–ë–™–Ø–í–õ–ï–ù–ò–Ø -->
        <div class="form-container" id="formContainer">
            <div class="form-header">
                <h2 style="font-size: 28px; color: #333; margin-bottom: 10px;">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                <p style="color: #666;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É, —á—Ç–æ–±—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h3 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p id="userEmail">email@example.com</p>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ -->
            <form id="adForm" onsubmit="event.preventDefault(); submitAd();">
                <div class="form-group">
                    <label class="form-label" for="adTitle">
                        –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è <span class="required">*</span>
                    </label>
                    <input type="text" id="adTitle" class="form-input" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–≤–µ–∂–∏–µ —Ä–æ–∑—ã, –±—É–∫–µ—Ç –Ω–µ–≤–µ—Å—Ç—ã" 
                           required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adDescription">
                        –û–ø–∏—Å–∞–Ω–∏–µ <span class="required">*</span>
                    </label>
                    <textarea id="adDescription" class="form-input form-textarea" 
                              placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ü–≤–µ—Ç—ã, —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥." 
                              required maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adPrice">
                        –¶–µ–Ω–∞ <span class="required">*</span>
                    </label>
                    <input type="text" id="adPrice" class="form-input" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000 —Å–æ–º –∏–ª–∏ –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="adPhone">
                        –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω <span class="required">*</span>
                    </label>
                    <input type="tel" id="adPhone" class="form-input" 
                           placeholder="+996 XXX XXX XXX" 
                           pattern="^\+996\s?\d{3}\s?\d{3}\s?\d{3}$" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5 —à—Ç—É–∫)</label>
                    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                        <i class="fas fa-camera photo-icon"></i>
                        <p><strong>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</strong></p>
                        <p class="photo-hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</p>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple 
                           style="display: none;" onchange="handlePhotoUpload(event)">
                    
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i>
                    <span>–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –û–ë–™–Ø–í–õ–ï–ù–ò–ï</span>
                </button>
            </form>
            
            <div id="formLoader" style="display: none; text-align: center; padding: 30px;">
                <div class="loader"></div>
                <p style="margin-top: 15px; color: #666;">–ü—É–±–ª–∏–∫—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...</p>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –£–°–ü–ï–•–ê -->
        <div class="success-screen" id="successScreen">
            <i class="fas fa-check-circle success-icon"></i>
            <h2 style="font-size: 32px; color: #333; margin-bottom: 15px;">–£—Å–ø–µ—à–Ω–æ!</h2>
            <p style="font-size: 18px; color: #666; margin-bottom: 25px; line-height: 1.5;" id="successMessage">
                –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ –Ω–∞—à–µ–º Telegram –∫–∞–Ω–∞–ª–µ.
            </p>
            
            <button class="google-btn" style="background: #667eea; max-width: 250px;" onclick="createNewAd()">
                <i class="fas fa-plus"></i>
                <span>–°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω–æ</span>
            </button>
            
            <p style="margin-top: 30px; color: #666; font-size: 14px;">
                <i class="fas fa-info-circle"></i>
                –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—à –∫–∞–Ω–∞–ª
                <a href="https://t.me/flowers_market_kg" target="_blank" style="color: #667eea; text-decoration: none;">@flowers_market_kg</a>
            </p>
        </div>
    </div>
    
    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div class="notification" id="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const BACKEND_URL = 'https://backend-flower-kyrgyz.up.railway.app';
        const GOOGLE_CLIENT_ID = '316866498988-v1pqivbgh0eupcb9rs53m26nrqukn9hb.apps.googleusercontent.com';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userId = null;
        let userData = null;
        let uploadedPhotos = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üå∫ Flower Market –∑–∞–ø—É—â–µ–Ω');
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            userId = urlParams.get('tg_user_id') || urlParams.get('userId') || generateUserId();
            
            console.log('üë§ User ID:', userId);
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ Google
                const response = await fetch(`${BACKEND_URL}/api/user/${userId}/status`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
                    
                    if (data.isLoggedIn) {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å—Ä–∞–∑—É
                        userData = data.user;
                        showForm();
                    } else {
                        // –ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Google
                        showAuthScreen();
                    }
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                showAuthScreen();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Sign-In
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleAuthResponse,
                    auto_select: false
                });
            }
        });
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω–µ—Ç Telegram ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('successScreen').style.display = 'none';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        function showForm() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('successScreen').style.display = 'none';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (userData) {
                document.getElementById('userName').textContent = userData.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userEmail').textContent = userData.email || '';
                
                const userAvatar = document.getElementById('userAvatar');
                if (userData.picture) {
                    userAvatar.innerHTML = `<img src="${userData.picture}" alt="–ê–≤–∞—Ç–∞—Ä">`;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏
                    const firstName = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                    userAvatar.innerHTML = firstName;
                }
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
        function showSuccessScreen() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('successScreen').style.display = 'block';
        }
        
        // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
        function signInWithGoogle() {
            const googleBtn = document.getElementById('googleSignInBtn');
            const authLoader = document.getElementById('authLoader');
            
            googleBtn.disabled = true;
            googleBtn.style.display = 'none';
            authLoader.style.display = 'block';
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            if (typeof google !== 'undefined') {
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        // –ï—Å–ª–∏ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –Ω–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å, —Å–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É
                        renderGoogleButton();
                    }
                });
            } else {
                showNotification('–û—à–∏–±–∫–∞', 'Google API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                googleBtn.disabled = false;
                googleBtn.style.display = 'flex';
                authLoader.style.display = 'none';
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–∫–∏ Google
        function renderGoogleButton() {
            const container = document.getElementById('googleSignInContainer');
            container.innerHTML = `
                <div id="googleButtonContainer"></div>
            `;
            
            if (typeof google !== 'undefined') {
                google.accounts.id.renderButton(
                    document.getElementById('googleButtonContainer'),
                    { 
                        theme: 'outline', 
                        size: 'large',
                        text: 'continue_with',
                        width: '350px'
                    }
                );
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ Google
        async function handleGoogleAuthResponse(response) {
            console.log('‚úÖ Google –æ—Ç–≤–µ—Ç:', response);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ –Ω–∞—à –±—ç–∫–µ–Ω–¥
                const authResult = await authenticateWithBackend(response.credential);
                
                if (authResult.success) {
                    userData = authResult.user;
                    showNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.name}!`, 'success');
                    showForm();
                } else {
                    throw new Error(authResult.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', error.message, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                document.getElementById('googleSignInBtn').disabled = false;
                document.getElementById('googleSignInBtn').style.display = 'flex';
                document.getElementById('authLoader').style.display = 'none';
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
                const container = document.getElementById('googleSignInContainer');
                container.innerHTML = `
                    <button class="google-btn" onclick="signInWithGoogle()" id="googleSignInBtn">
                        <i class="fab fa-google"></i>
                        <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                    </button>
                    <p style="color: #666; margin-top: 15px; font-size: 14px;">
                        –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                    </p>
                `;
            }
        }
        
        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥
        async function authenticateWithBackend(token) {
            const response = await fetch(`${BACKEND_URL}/api/auth/google`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    telegramUserId: userId
                })
            });
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const maxFiles = 5;
            
            if (files.length === 0) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
            if (uploadedPhotos.length + files.length > maxFiles) {
                showNotification('–û—à–∏–±–∫–∞', `–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${maxFiles} —Ñ–æ—Ç–æ`, 'error');
                return;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', `–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`, 'warning');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB
                    showNotification('–í–Ω–∏–º–∞–Ω–∏–µ', `–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)`, 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = {
                        id: Date.now() + Math.random(),
                        file: file,
                        url: e.target.result,
                        name: file.name
                    };
                    
                    uploadedPhotos.push(photoData);
                    updatePhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            
            event.target.value = '';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            uploadedPhotos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.url}" alt="–§–æ—Ç–æ ${index + 1}" loading="lazy">
                    <button class="remove-photo" onclick="removePhoto(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(item);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            updatePhotoPreview();
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        async function submitAd() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
            const title = document.getElementById('adTitle').value.trim();
            const description = document.getElementById('adDescription').value.trim();
            const price = document.getElementById('adPrice').value.trim();
            const phone = document.getElementById('adPhone').value.trim();
            
            if (!title || !description || !price || !phone) {
                showNotification('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (!userData) {
                showNotification('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const formLoader = document.getElementById('formLoader');
            
            submitBtn.disabled = true;
            submitBtn.style.display = 'none';
            formLoader.style.display = 'block';
            
            try {
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const formData = {
                    userId: userId,
                    title: title,
                    description: description,
                    price: price,
                    contactInfo: phone,
                    images: []
                };
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –≤ base64
                for (const photo of uploadedPhotos) {
                    const base64Data = photo.url.split(',')[1];
                    formData.images.push({
                        name: photo.name,
                        data: base64Data,
                        type: photo.file.type
                    });
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥
                const response = await fetch(`${BACKEND_URL}/api/publish-ad`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    document.getElementById('successMessage').innerHTML = `
                        –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ –Ω–∞—à–µ–º Telegram –∫–∞–Ω–∞–ª–µ.<br>
                        ${uploadedPhotos.length > 0 ? `üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${uploadedPhotos.length}` : ''}
                    `;
                    
                    showNotification('–£—Å–ø–µ—à–Ω–æ', '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!', 'success');
                    showSuccessScreen();
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞', error.message, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
                submitBtn.style.display = 'flex';
                formLoader.style.display = 'none';
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
        function createNewAd() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('adForm').reset();
            uploadedPhotos = [];
            updatePhotoPreview();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            showForm();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" 
                       style="color: ${type === 'success' ? '#34c759' : type === 'error' ? '#ff3b30' : '#007aff'}; 
                              margin-right: 10px; font-size: 20px;"></i>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">${title}</div>
                        <div style="color: #666; font-size: 14px;">${message}</div>
                    </div>
                </div>
            `;
            
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        console.log('‚úÖ Flower Market –≥–æ—Ç–æ–≤!');
    </script>
</body>
</html>